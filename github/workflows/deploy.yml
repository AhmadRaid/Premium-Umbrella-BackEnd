name: Deploy Backend

on:
  push:
    branches:
      - main # ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø°ÙŠ ØªØ³ØªØ®Ø¯Ù…Ù‡ Ù„Ù„Ù†Ø´Ø±

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.5' # ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙŠØ·Ø§Ø¨Ù‚ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø®Ø§Ø¯Ù…

      - name: Install dependencies and Build
        run: |
          npm install
          npm run build 

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù€ VPS
            cd /var/www/my-full-stack-app/backend # ğŸ‘ˆ Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø±

            # 2. Ø³Ø­Ø¨ Ø¢Ø®Ø± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            git pull origin main 

            # 3. Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙÙŠ PM2
            pm2 restart nest-backend # ğŸ‘ˆ Ø¹Ø¯Ù‘Ù„ Ø§Ø³Ù… ØªØ·Ø¨ÙŠÙ‚Ùƒ ÙÙŠ PM2